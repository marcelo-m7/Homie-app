{% extends "base.html" %}

{% block title %}Bills - Homie{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Simple Header -->
    <div class="mb-8 mt-4">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
            <i class="fas fa-receipt mr-3 text-gray-600"></i>Bills Manager
        </h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">
            Track your monthly bills and total cost
        </p>
    </div>

    <!-- Monthly Total Card -->
    <div class="bg-gradient-to-r from-gray-300 to-gray-400 text-white rounded-xl p-8 mb-8 shadow-lg">
        <div class="text-center">
            <h2 class="text-2xl font-bold mb-2">Monthly Total</h2>
            <p class="text-5xl font-bold">{{ currency }}{{ "%.2f"|format(monthly_total or 0) }}</p>
            <p class="text-grey-100 mt-2">{{ bills|length }} bill{{ 's' if bills|length != 1 else '' }} tracked</p>
        </div>
    </div>

    <!-- Add Bill Form -->
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl border border-gray-200 dark:border-gray-700 mb-8">
        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="fas fa-plus-circle mr-2 text-gray-400"></i>Add New Bill
            </h3>
        </div>
        <div class="p-6">
            <form method="POST" action="{{ url_for('bills.add_bill') }}" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="bill_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Bill Name *
                        </label>
                        <input type="text" name="bill_name" id="bill_name" required
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-transparent transition-all"
                               placeholder="e.g., Electricity, Gas, Netflix">
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Amount ({{ currency }}) *
                        </label>
                        <input type="number" name="amount" id="amount" step="0.01" min="0" required
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-transparent transition-all"
                               placeholder="0.00">
                    </div>
                    <div>
                        <label for="due_day" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Due Day *
                        </label>
                        <select name="due_day" id="due_day" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-transparent transition-all">
                            <option value="">Select day</option>
                            {% for day in range(1, 32) %}
                            <option value="{{ day }}">{{ day }}{{ 'st' if day == 1 or day == 21 or day == 31 else ('nd' if day == 2 or day == 22 else ('rd' if day == 3 or day == 23 else 'th')) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit"
                            class="px-6 py-3 bg-gray-400 hover:bg-gray-300 text-white font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all duration-200 shadow-lg hover:shadow-xl">
                        <i class="fas fa-plus mr-2"></i>Add Bill
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bills List -->
    {% if bills %}
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl border border-gray-200 dark:border-gray-700">
        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                Your Bills
            </h3>
        </div>
        <div class="divide-y divide-gray-200 dark:divide-gray-700">
            {% for bill in bills|sort(attribute='due_day') %}
            <div class="item-row p-6 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0 h-12 w-12 bg-gradient-to-br from-gray-300 to-gray-400 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-receipt text-white"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">
                                {{ bill.bill_name }}
                            </h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                Due: {{ bill.due_day }}{{ 'st' if bill.due_day == 1 or bill.due_day == 21 or bill.due_day == 31 else ('nd' if bill.due_day == 2 or bill.due_day == 22 else ('rd' if bill.due_day == 3 or bill.due_day == 23 else 'th')) }} of each month
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-900 dark:text-white">
                                {{ currency }}{{ "%.2f"|format(bill.amount) }}
                            </p>
                        </div>
                        <!-- Actions Dropdown -->
                        <div class="relative action-dropdown">
                            <button onclick="toggleActionMenu('bill-menu-{{ bill.id }}')"
                                    class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div id="bill-menu-{{ bill.id }}" class="action-menu hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl ring-1 ring-black ring-opacity-5 z-20 border border-gray-200 dark:border-gray-600">
                                <button onclick="editBill({{ bill.id }}, '{{ bill.bill_name }}', {{ bill.amount }}, {{ bill.due_day }})"
                                        class="block w-full text-left px-4 py-3 text-sm text-blue-600 dark:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-t-lg transition-colors">
                                    <i class="fas fa-edit mr-2"></i>Edit Bill
                                </button>
                                <button onclick="deleteBill({{ bill.id }}, this)"
                                        class="block w-full text-left px-4 py-3 text-sm text-gray-400 dark:text-red-400 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-b-lg transition-colors border-t border-gray-200 dark:border-gray-600">
                                    <i class="fas fa-trash mr-2"></i>Delete Bill
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-16">
        <div class="bg-gray-100 dark:bg-gray-800 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-receipt text-4xl text-gray-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
            No bills tracked yet
        </h3>
        <p class="text-gray-600 dark:text-gray-400 mb-6 max-w-md mx-auto">
            Start tracking your monthly bills by adding your first bill above.
        </p>
        <button onclick="document.getElementById('bill_name').focus()" 
                class="px-6 py-3 bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white font-medium rounded-lg transition-colors">
            <i class="fas fa-plus mr-2"></i>Add Your First Bill
        </button>
    </div>
    {% endif %}
</div>

<!-- Simple Edit Bill Modal -->
<div id="editBillModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center">
    <div class="relative mx-auto p-0 border-0 w-full max-w-lg shadow-2xl rounded-xl bg-white dark:bg-gray-800 m-4">
        <div class="relative">
            <!-- Modal Header -->
            <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-gray-300 to-gray-400 text-gray-800 rounded-t-xl">
                <h3 class="text-xl font-semibold">
                    <i class="fas fa-edit mr-2"></i>Edit Bill
                </h3>
                <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6">
                <form id="editBillForm" method="POST" action="/edit_bill" class="space-y-4">
                    <input type="hidden" id="editBillId" name="bill_id">
                    <div>
                        <label for="editBillName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Bill Name *
                        </label>
                        <input type="text" id="editBillName" name="bill_name" required
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label for="editAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Amount ({{ currency }}) *
                        </label>
                        <input type="number" id="editAmount" name="amount" step="0.01" min="0" required
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label for="editDueDay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Due Day of Month *
                        </label>
                        <select id="editDueDay" name="due_day" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-transparent transition-all">
                            {% for day in range(1, 32) %}
                            <option value="{{ day }}">{{ day }}{{ 'st' if day == 1 or day == 21 or day == 31 else ('nd' if day == 2 or day == 22 else ('rd' if day == 3 or day == 23 else 'th')) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Modal Actions -->
                    <div class="flex justify-end space-x-3 pt-6">
                        <button type="button" onclick="closeEditModal()"
                                class="px-6 py-3 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors font-medium">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-6 py-3 bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white rounded-lg transition-colors font-medium shadow-lg">
                            <i class="fas fa-save mr-2"></i>Update Bill
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Currency symbol from server
const CURRENCY = '{{ currency }}';

function editBill(billId, billName, amount, dueDay) {
    document.getElementById('editBillId').value = billId;
    document.getElementById('editBillName').value = billName;
    document.getElementById('editAmount').value = amount;
    document.getElementById('editDueDay').value = dueDay;
    document.getElementById('editBillModal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editBillModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('editBillModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});

// Animate number counting up
function animateCountUp(element, start, end, duration = 1500) {
    const startTime = performance.now();
    const difference = end - start;
    
    function updateCount(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth animation
        const easeOutCubic = 1 - Math.pow(1 - progress, 3);
        const current = start + (difference * easeOutCubic);
        
        element.textContent = CURRENCY + current.toFixed(2);
        
        if (progress < 1) {
            requestAnimationFrame(updateCount);
        }
    }
    
    requestAnimationFrame(updateCount);
}

// Calculate current total from DOM
function calculateCurrentTotal() {
    const billElements = document.querySelectorAll('.item-row');
    let total = 0;
    
    billElements.forEach(row => {
        const amountText = row.querySelector('.text-2xl.font-bold').textContent;
        const amount = parseFloat(amountText.replace(CURRENCY, ''));
        if (!isNaN(amount)) {
            total += amount;
        }
    });
    
    return total;
}

// Update monthly total display
function updateMonthlyTotal(newTotal = null) {
    const totalElement = document.querySelector('.text-5xl.font-bold');
    const countElement = document.querySelector('.text-blue-100');
    
    if (!totalElement) return;
    
    const currentDisplayed = parseFloat(totalElement.textContent.replace(CURRENCY, '')) || 0;
    const actualTotal = newTotal !== null ? newTotal : calculateCurrentTotal();
    const billCount = document.querySelectorAll('.item-row').length;
    
    // Animate the count up/down
    animateCountUp(totalElement, currentDisplayed, actualTotal, 800);
    
    // Update bill count
    setTimeout(() => {
        countElement.textContent = `${billCount} bill${billCount !== 1 ? 's' : ''} tracked`;
    }, 400);
}

// Override the deleteItem function for bills to trigger recount
function deleteBill(billId, element) {
    if (confirm('Are you sure you want to delete this bill?')) {
        // Get the amount before deletion for smooth animation
        const billRow = element.closest('.item-row');
        const amountText = billRow.querySelector('.text-2xl.font-bold').textContent;
        const deletedAmount = parseFloat(amountText.replace(CURRENCY, ''));
        
        fetch(`/delete_bill/${billId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Animate the row removal
                billRow.style.transition = 'all 0.3s ease';
                billRow.style.opacity = '0';
                billRow.style.transform = 'translateX(-100%)';
                
                setTimeout(() => {
                    billRow.remove();
                    // Trigger total recount animation
                    updateMonthlyTotal();
                    
                    // Show empty state if no bills left
                    if (document.querySelectorAll('.item-row').length === 0) {
                        location.reload(); // Reload to show empty state
                    }
                }, 300);
            } else {
                alert('Error deleting bill');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting bill');
        });
    }
}

// Simple animations
document.addEventListener('DOMContentLoaded', function() {
    // Animate cards appearing
    const cards = document.querySelectorAll('.bg-white, .bg-gradient-to-r');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Animate the monthly total counting up on page load
    setTimeout(() => {
        const totalElement = document.querySelector('.text-5xl.font-bold');
        if (totalElement) {
            const finalTotal = parseFloat(totalElement.textContent.replace(CURRENCY, ''));
            totalElement.textContent = CURRENCY + '0.00';
            animateCountUp(totalElement, 0, finalTotal, 1500);
        }
    }, 500);
});
</script>
{% endblock %}